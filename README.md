# B2C电商平台优惠概念和架构设计

## 备忘录

- 单一优惠券，包含多个阶段。

  通过在优惠上建一层可一对多的优惠抽象层实现。

  叠加和一对多的区别。

  引申：

  新建抽象层的映射方式。

    1. 列表，由前到后优惠力度增大。
    2. 和类型，同时由两个不同优惠的对象的优惠。
    3. 一对一类型。

- 订单的抽象

- 商品的抽象

- 属性的抽象45

## 目录

1. 概述
2. 基础概念
3. 分析
    1. 优惠案例考察
        1. 优惠券
        2. 限时活动
        3. 积分兑换
    2. 抽象
4. 设计
5. 总结

## 概述

电商平台为了赚取更多了利润、清空仓储、扩张市场，往往会设计多种不同的促销优惠业务来满足其目的，如：优惠券、限时活动、运费优惠等。

本文聚焦于在该背景下，尝试对所涉及到的业务进行总体的抽象和统一，提取通用的概念，并最终将这些落实到实际的架构和编码中。

## 基础概念

1. 订单

   包含：

    - 商品及其数量
    - 运输方式和地址
    - 优惠信息
    - 其它必要信息
    - 在前者的基础上得到的需要支付的金额、优惠金额信息

2. 运输方式和运费

   为了满足客户对运输时长、运输保密性、运输服务的不同要求，可以提供多种运输方式。

   运费由运输方式、收货地址、商品数量共同决定。

3. 结算

   确定订单信息并生成订单的过程。

4. 优惠

   作为名词，实际**结算金额**和**商品金额与运费金额之和**的**绝对差值**。

   作为动词，**计算**实际结算金额和商品金额与运费金额之和的绝对差值，并将该差值加入到订单之中。

5. 商品

   本文中的商品皆为库存的基本单位sku。

   商品有唯一的标识符。

   商品与一定数量的商品属性联系起来。

6. 商品属性

   属性描述了商品的物理实体。

   属性有唯一的标识符。

7. 售前/售后

   支付成功前的流程即为售前；支付成功后B方开始处理订单以及其相关业务的流程为售后。

## 分析

### 优惠案例考察

这里给出以下几类案例：

- 优惠券
- 活动
- 积分兑换

#### 优惠券

优惠券既可以与***用户绑定***——即只有用户通过某种方式”获取“了优惠券之后才能使用；也可以以不限用户的方式让用户选用，即非***用户绑定***。

优惠券通常会有***起始时间***；***有效时间***是优惠券的可能属性，但不是必须——有效时间可以无穷大。事实上，当一个优惠券的有效期大于一定时常就可以认为没有有效期，例如：10年有效期的优惠券。

对于优惠券，给出以下三种案例：

- 百分比减额 / 直接减额 / 买N件M件免费 折扣优惠券

  此种优惠券会直接在结算的商品基础上进行优惠，可能会包括数量或者金额的限制。此外，优惠的适用范围也有可能有限制。

  例如：

    1. 如果结算的金额超过100元，减5元或者打8折；
    2. 如果结算的金额超过100元，其中3件打8折；
    3. 如果结算的商品数量超过8件，减20元或者打6折；
    4. 如果结算的商品数量超过8件，其中5件打6折；

  此外，也可能出现买10件，其中3件免费的情况。

  **实践中，上述中其中之后的的商品的选择，往往是将所有结算的商品按价格从低到高排列，再从低到高依次选取优惠。**

- 品类优惠券

  故名思与，品类优惠券针对于某一品类的商品进行优惠。

  例如：

    1. 泳衣品类减5元或者打8折；
    2. 帽子品类结算的商品数量超过8件，其中5件打6折。

  通过在百分比减额 / 直接减额 / 买N件M件免费 折扣优惠券的限制基础上**再限制品类**，就可以实现这一目的。

  值得注意的是，为了最大的营销效果，品类优惠券常常可以叠加适用：比如，如果结算的商品中既包含了泳衣，也包含了帽子，上述优惠是有可能一起使用的；同时，百分比减额 / 直接减额 / 买N件M件免费的优惠券也有可能一起适用。

  此时，需要关注如何计算优惠的问题：

  例如，某位客户选取了泳衣品类5件、其它品类商品4件，同时满足了泳衣品类打8折，以及结算的商品数量超过8件，其中5件打6折两种优惠（如果用户可以使用这两种优惠券的话），优惠如何计算？

  一个较好的处理方法是：

  ```
  总优惠 = 泳衣品类原价总价 * （1 - 0.8）+  所有商品原价价格较低的5件的总价 * （1 - 0.6）。
  ```

- 运费优惠券

  例如，某已结算的订单，发现其中有一件或者几件缺货，无法发货。

  此时可以有几种处理方式：

    1. 向用户退款；
    2. 不退款但给予优惠券形式的补偿；
    3. 退款的同时给予优惠券形式的补偿。

  优惠券形式的补偿可以选择运费减额（甚至免邮的优惠券）。

  除了缺货补偿外，也可以创建满足类似上述两种优惠券所采用的限制条件之后进行运费减免的优惠券。例如：某品类的商品满5件运费打8折。

#### 限时活动

限时活动与不与用户绑定的优惠券具有十分类似的属性，但往往有自己的展示渠道，并且可以与优惠券叠加使用。

每个限时活动往往会限制自己应用的商品。一般情况下，一个商品只能参与一个限时活动。

在大多数情况下，限时活动是具有***强制性***的：大多数情况下，对于限时活动框定的商品，用户既不能选择商品参与或者不参与活动，也不能选择参与哪个活动。

**当然，可选择的情形以及同时参与多个限时活动的情形也是需要进行考虑的——你永远不知道需求会有多么的放肆——但这两种本文不进行更多的讨论。**

下面考察两种限时活动：

- 满减/折扣活动
    1. 满300元减100元限时活动；
    2. 满100元打95折。
- 买X送Y/X件固定P元活动
    1. 参与限时活动的商品三件固定50元；
    2. 参与限时活动的商品满4件其中一件免费。

**限时活动与优惠券叠加使用时，一般先计算限时活动的折扣，并在减去优惠（或减去免费的件数）的基础上再进行优惠券的计算。**

**限时活动一般也可以与自己进行叠加，即满300元减100元限时活动当作用于600元的订单时就变成了满600元减200元。**

例如：

结算时某商品4件320元，满足满300元减100元限时活动的同时也满足了满100元打95折优惠券，总优惠计算为

```
限时活动优惠 = 100元

限时活动优惠折扣后价格 = 原价320元 - 100元 = 220元

优惠券优惠 = 限时活动优惠折扣后价格 * （1 - 0.95）= 220元 * 0.05 = 11元

总优惠 = 限时活动优惠 + 优惠券优惠 = 100元 + 11元 = 111元
```

除上例之外，买X送Y的限时活动与对于某几件商品其中几件进行优惠的优惠券同时使用时也有一个需要特别注意的点：

买X送Y的限时活动中**送Y**的含义到底是给予用户Y件等额的优惠；还是真的这Y件就不要钱。

如果是后者，那么优惠券计算优惠时使用的商品价格就是经过限时活动优惠之后的价格。

如果是前者，那么显然，Y件商品就是结算订单中价格最低的一批商品，在它们之上的优惠就是一个逻辑上的错误——对于已经价格为0的商品，怎么可以再次进行优惠呢？有一种解决方式为，将这Y件认作为“赠品”，排除到件数限制条件外。举一个例子：

设某订单7件商品，则买3减1的活动，重叠执行了两次，即变为买6减2，同时有一个买四件其中一件减20%的优惠券。优惠过程如下：

```
将7件商品按价格从第到高排序，A B C D E F G。
其中A，B被价格最低，变为赠品。
因为还剩余C,D,E,F,G五件，满足买三件其中一件减20%的优惠券。
那么，C获得其金额20%的优惠。
```

如果该订单只有4件，则因为排除赠品后只剩余3件，并不满足买三件其中一件减20%的优惠券。

#### 积分兑换

为了增强用户的粘性，提高回头客的数量，往往会采用类似于积分系统的手段，让用户过往的消费行为可以转换为新的优惠，从而促进老用户新消费的产生。

考虑这样两个积分系统：

1. 获取的积分可以直接应用于订单，减免一定金额。
2. 获取的积分可以手动兑换成优惠券。

实际上，这两种业务的形式并没有本质的区别。

对于第一种积分形式，可以在生成订单时，将积分转换为一个匿名优惠券自动使用，优惠券的金额由积分至优惠金额的转换公式决定。

对于第二种积分形式则更加简单明了，不再赘述。

可以看到，积分系统本身及其附带的优惠并没有和优惠券本身的逻辑有非常强的耦合性。

### 抽象

经过上述的讨论，可以总结出优惠的一般属性。

从最基本的几个方面讲：

1. 第一个方面，从优惠的对象开始：

    - **优惠的对象**，在电商的背景下也只有两个，必选一个：**运费**和**商品**本身的费用。

      这里展开一点：这里考虑的优惠对象，随着购物业务环节的增加和多样化有可能变得更多。

      例如，可能存在退货时邮费的优惠——优惠的对象时退货时的邮费。

      又例如，售前的时可能存在建立在运输险——一种包裹丢失等意外情况会进行重发或者佩服的保险——上的优惠。

      售后的流程暂且不论，一种新的售前费用的优惠是**应当可以**简便地添加进优惠系统的。

      此外，从运费和商品作为优惠的对象的关系考察，可以发现，一个优惠没有理由阻止（复杂性不能阻止业务的需求）一个优惠同时具有运费和商品两种优惠对象。

    - **优惠的形式**。既然是优惠，就会有**优惠的值**。

      值有三种，**百分比**或者直接的**金额**。

      另外还有比较特殊的**固定金额**，指的是无论原本商品多少钱，使用优惠后就会成为优惠指定的金额。显然，固定金额不适用于优惠的对象是运费的情况。

   但很明显优惠并不是随意的抛给用户，而是可能会存在限制条件。可以分为两个点：商品集合限制，和适用条件限制。

    - **商品集合限制**。

      这种限制有两种：

        1. 一种，划分出一部分sku的集合，，只有订单中的商品在该sku的集合中，**且在数量或者金额达到某个条件时**，才可以适用优惠。
        2. 另一种，指出一系列的属性，这些属性指定了一个潜在的sku的集合，只有订单中的商品在该潜在的sku的集合中，**且在数量或者金额达到某个条件时**，才可以适用优惠。

      这两种方式的最终目的都是构建一个sku的集合，但因为方式不同，具有不同的特点。

        1. 第一种，直接指定sku集合，可以解除与商品属性的耦合，但相应的，该集合的的添加、删除操作就需要手动/间接手动的进行。
        2. 第二种，通过指定属性构建sku集合，可以保证当新的商品被附着了指定的标签、或者当老的商品去除了指定的标签时，sku的集合可以实时更新，减少了操作，但因为与商品属性耦合，降低了灵活性。

      除了两种限制外，商品集合也可以是所有商品——即没有该限制。

    - **适用条件限制**，即商品集合限制描述中的“**且在数量或者金额达到某个条件时**”中的某个条件的形式和值。

      如描述，这种条件分为两种，金额或者数量；此外，也可以完全不进行限制。

   除了限制条件外，优惠本身还可以存在适用的范围。但这种情形只会存在于优惠的对象为商品时——当优惠的对象为运费时，显然，适用的对象只能是运费。

    - **适用范围限制**，具体来说就是，订单中存在于前述**商品集合**中的商品中，有哪些可以运用优惠包含的优惠的形式得到优惠。

      比较现实的只有两种可能：**不限制**或者按**件数**。

      但当优惠的形式是百分比的时候，价格高低不同的商品如何决定哪些商品的价格来结算百分比的优惠呢？前文对优惠券的分析中已经指出：商品按价格从低到高排列，按顺序拿足适用范围限制要求的件数进行计算。

   最后，还有一个特殊的属性——叠加性：

    - 叠加限制，指的是，当条件（适用范围限制）被重复满足多次，优惠的计算是否会按照优惠形式重复计算相对应的多次。

      仅有两种情形：不限制，限制某几次。

   通过上面的这些属性，我们已经可以构建出一些优惠券了。如：

    - 任意购买商品可以享受直接减额或者百分比减额的优惠对象为运费或者商品优惠券；

    - 指定商品集合中购买X件，其中Y件可以直接减额或者百分比减额，或者固定P元，同时可以进行叠加；
    - ……

2. 第二个方面，从时间维度上考察。

   首先，优惠可能具有时间维度上的限制。

    - **限制期限**，即在多上的连续的时间段内，优惠可以被使用。

      它有两个子属性可以单独或者（必须）组合成为一个限制期限。子属性为：

        1. 起点确定，即一个优惠从某个时间点之后都可以使用。当该时间点比优惠本身创建的时间点还要早、或者就是优惠本身创建的时间点，优惠就可以被认为没有限制期限。
        2. 时长确定，即一个优惠券可以确定它的有效期有多久。必须和起点确定一起，最终决定优惠的使用期限。

   其次，同一个优惠可能具有时间维度上次数限制。

    - **次数限制**，即某一个优惠，对于某一个用户，可以使用多少次；当然，也可以没有次数限制。

3.  第三个方面是从用户操作的角度考虑：

- **用户绑定**，即是否指定某些用户才可以适用优惠，或者是所有的用户都可以适用。
- **可选择性**，优惠本身是否具有强制性，即用户是否可以选择适用或者不使用优惠。
- **可见性**，优惠是否可以在优惠中心类似的地方被用户看到；如果不能，用户唯一使用优惠的办法就是手动键入优惠的唯一标识符。

## 设计



## 总结







