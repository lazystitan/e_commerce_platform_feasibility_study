# B2C电商平台优惠概念和架构设计

## 目录

待完成

## 概述

电商平台为了赚取更多了利润、清空仓储、扩张市场，往往会设计多种不同的促销优惠业务来满足其目的，如：优惠券、限时活动、运费优惠等。

本文聚焦于在该背景下，尝试对所涉及到的业务进行总体的抽象和统一，提取通用的概念，并最终将这些落实到实际的架构和编码中。

## 基础概念

1. 订单

   包含：

    - 商品及其数量
    - 运输方式和地址
    - 优惠信息
    - 其它必要信息
    - 在前者的基础上得到的需要支付的金额、优惠金额信息

2. 结算

   确定订单信息并生成订单的过程。

3. 优惠

   作为名词，实际**结算金额**和**商品金额与运费金额之和**的**绝对差值**。

   作为动词，**计算**实际结算金额和商品金额与运费金额之和的绝对差值，并将该差值加入到订单之中。

4. 商品

   本文中的商品皆为库存的基本单位sku。

## 分析

### 优惠案例考察

这里给出以下几类案例：

- 优惠券
- 活动
- 积分兑换

#### 优惠券

优惠券既可以与***用户绑定***——即只有用户通过某种方式”获取“了优惠券之后才能使用；也可以以不限用户的方式让用户选用，即非***用户绑定***。

优惠券通常会有***起始时间***；***有效时间***是优惠券的可能属性，但不是必须——有效时间可以无穷大。事实上，当一个优惠券的有效期大于一定时常就可以认为没有有效期，例如：10年有效期的优惠券。

对于优惠券，给出以下三种案例：

- 百分比减额 / 直接减额 / 买N件M件免费 折扣优惠券

  此种优惠券会直接在结算的商品基础上进行优惠，可能会包括数量或者金额的限制。此外，优惠的适用范围也有可能有限制。

  例如：

    1. 如果结算的金额超过100元，减5元或者打8折；
    2. 如果结算的金额超过100元，其中3件打8折；
    3. 如果结算的商品数量超过8件，减20元或者打6折；
    4. 如果结算的商品数量超过8件，其中5件打6折；

  此外，也可能出现买10件，其中3件免费的情况。

  **实践中，上述中其中之后的的商品的选择，往往是将所有结算的商品按价格从低到高排列，再从低到高依次选取优惠。**

- 品类优惠券

  故名思与，品类优惠券针对于某一品类的商品进行优惠。

  例如：

    1. 泳衣品类减5元或者打8折；
    2. 帽子品类结算的商品数量超过8件，其中5件打6折。

  通过在百分比减额 / 直接减额 / 买N件M件免费 折扣优惠券的限制基础上**再限制品类**，就可以实现这一目的。

  值得注意的是，为了最大的营销效果，品类优惠券常常可以叠加适用：比如，如果结算的商品中既包含了泳衣，也包含了帽子，上述优惠是有可能一起使用的；同时，百分比减额 / 直接减额 / 买N件M件免费的优惠券也有可能一起适用。

  此时，需要关注如何计算优惠的问题：

  例如，某位客户选取了泳衣品类5件、其它品类商品4件，同时满足了泳衣品类打8折，以及结算的商品数量超过8件，其中5件打6折两种优惠（如果用户可以使用这两种优惠券的话），优惠如何计算？

  一个较好的处理方法是：

  ```
  总优惠 = 泳衣品类原价总价 * （1 - 0.8）+  所有商品原价价格较低的5件的总价 * （1 - 0.6）。
  ```

- 运费优惠券

  例如，某已结算的订单，发现其中有一件或者几件缺货，无法发货。

  此时可以有几种处理方式：

    1. 向用户退款；
    2. 不退款但给予优惠券形式的补偿；
    3. 退款的同时给予优惠券形式的补偿。

  优惠券形式的补偿可以选择运费减额（甚至免邮的优惠券）。

  除了缺货补偿外，也可以创建满足类似上述两种优惠券所采用的限制条件之后进行运费减免的优惠券。例如：某品类的商品满5件运费打8折。

#### 限时活动

限时活动与不与用户绑定的优惠券具有十分类似的属性，但往往有自己的展示渠道，并且可以与优惠券叠加使用。

每个限时活动往往会限制自己应用的商品。一般情况下，一个商品只能参与一个限时活动。

在大多数情况下，限时活动是具有***强制性***的：大多数情况下，对于限时活动框定的商品，用户既不能选择商品参与或者不参与活动，也不能选择参与哪个活动。

**当然，可选择的情形以及同时参与多个限时活动的情形也是需要进行考虑的——你永远不知道需求会有多么的放肆——但这两种本文不进行更多的讨论。**

下面考察两种限时活动：

- 满减/折扣活动
    1. 满300元减100元限时活动；
    2. 满100元打95折。
- 买X送Y/X件固定P元活动
    1. 参与限时活动的商品三件固定50元；
    2. 参与限时活动的商品满4件其中一件免费。

**限时活动与优惠券叠加使用时，一般先计算限时活动的折扣，并在减去优惠（或减去免费的件数）的基础上再进行优惠券的计算。**

**限时活动一般也可以与自己进行叠加，即满300元减100元限时活动当作用于600元的订单时就变成了满600元减200元。**

例如：

结算时某商品4件320元，满足满300元减100元限时活动的同时也满足了满100元打95折优惠券，总优惠计算为

```
限时活动优惠 = 100元

限时活动优惠折扣后价格 = 原价320元 - 100元 = 220元

优惠券优惠 = 限时活动优惠折扣后价格 * （1 - 0.95）= 220元 * 0.05 = 11元

总优惠 = 限时活动优惠 + 优惠券优惠 = 100元 + 11元 = 111元
```

除上例之外，买X送Y的限时活动与对于某几件商品其中几件进行优惠的优惠券同时使用时也有一个需要特别注意的点：

买X送Y的限时活动中**送Y**的含义到底是给予用户Y件等额的优惠；还是真的这Y件就不要钱。

如果是后者，那么优惠券计算优惠时使用的商品价格就是经过限时活动优惠之后的价格。

如果是前者，那么显然，Y件商品就是结算订单中价格最低的一批商品，在它们之上的优惠就是一个逻辑上的错误——对于已经价格为0的商品，怎么可以再次进行优惠呢？有一种解决方式为，将这Y件认作为“赠品”，排除到件数限制条件外。举一个例子：

设某订单7件商品，则买3减1的活动，重叠执行了两次，即变为买6减2，同时有一个买四件其中一件减20%的优惠券。优惠过程如下：

```
将7件商品按价格从第到高排序，A B C D E F G。
其中A，B被价格最低，变为赠品。
因为还剩余C,D,E,F,G五件，满足买三件其中一件减20%的优惠券。
那么，C获得其金额20%的优惠。
```

如果该订单只有4件，则因为排除赠品后只剩余3件，并不满足买三件其中一件减20%的优惠券。

#### 积分兑换

为了增强用户的粘性，提高回头客的数量，往往会采用类似于积分系统的手段，让用户过往的消费行为可以转换为新的优惠，从而促进老用户新消费的产生。

考虑这样两个积分系统：

1. 获取的积分可以直接应用于订单，减免一定金额。
2. 获取的积分可以手动兑换成优惠券。

实际上，这两种业务的形式并没有本质的区别。

对于第一种积分形式，可以在生成订单时，将积分转换为一个匿名优惠券自动使用，优惠券的金额由积分至优惠金额的转换公式决定。

对于第二种积分形式则更加简单明了，不再赘述。

可以看到，积分系统本身及其附带的优惠并没有和优惠券本身的逻辑有非常强的耦合性。

### 抽象

待完成

## 设计

### 概念设计

根据节的抽象，可以将所有的基础概念做一次总结和简短的描述。

待完成

### 数据设计

立足于概念设计，就可以设计所需要的数据结构和其行为了。

待完成

## 总结

待完成

## 后记

待完成



